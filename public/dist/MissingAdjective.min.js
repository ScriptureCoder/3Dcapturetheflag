/*! MissingAdjective 29-06-2015 */
var envVariables={player:null,flag:null,base0:null,base1:null,moveSpeed:5,score:{0:0,1:0},playerContainer:{},winCondition:!1,winningTeam:null},windowVariables={maxWidth:800,maxHeight:600,minWidth:0,minHeight:0},canvas=document.getElementById("canvas"),canvasContext=canvas.getContext("2d"),keysPressedArr=[],Collisions={},socket=io(),Base=function(a,b,c,d){this.canvasContext=b,this.position={x:a.x,y:a.y},this.radius=d||50,this.team=c,0===this.team?this.color="rgb(0,0,200)":this.color="rgb(255,0,0)"};Base.prototype.draw=function(){this.canvasContext.strokeStyle=this.color;var a=new Path2D;a.arc(this.position.x,this.position.y,this.radius,0,2*Math.PI,!1),this.canvasContext.stroke(a),a=new Path2D,a.arc(this.position.x,this.position.y,this.radius/5,2*Math.PI,!1),this.canvasContext.stroke(a)};var movementLogic=function(a,b){var c=!1;envVariables.player.position[a]+=envVariables.moveSpeed*b;for(var d in envVariables.playerContainer){var e=envVariables.playerContainer[d];Collisions.playerDetection(envVariables.player,e)&&(c=!0)}Collisions.windowDetection(envVariables.player.position[a],a)&&!c?(Collisions.flagDetection(envVariables.player,envVariables.flag),Collisions.baseDetection(envVariables.player,envVariables["base"+envVariables.player.team])&&(envVariables.player.score=!0,envVariables.player.hasFlag=null,envVariables.flag.drop(),socket.emit("playerScores")),socket.emit("updatePosition",JSON.stringify(envVariables.player.position),JSON.stringify(envVariables.player.hasFlag))):(envVariables.player.position[a]+=envVariables.moveSpeed*b*-2,c=!1)},update=function(){keysPressedArr.indexOf("right")>-1&&movementLogic("x",1),keysPressedArr.indexOf("down")>-1&&movementLogic("y",1),keysPressedArr.indexOf("left")>-1&&movementLogic("x",-1),keysPressedArr.indexOf("up")>-1&&movementLogic("y",-1),envVariables.flag.update()},draw=function(){envVariables.winCondition?(canvasContext.font="72px Ariel",0===envVariables.winningTeam?canvasContext.fillText("BLUE TEAM WINS!!!!!",25,100):canvasContext.fillText("RED TEAM WINS!!!!!",25,100)):canvasContext.clearRect(windowVariables.minWidth,windowVariables.minHeight,windowVariables.maxWidth,windowVariables.maxHeight),envVariables.player.draw(),envVariables.flag.draw(),envVariables.base0.draw(),envVariables.base1.draw();for(playerId in envVariables.playerContainer)envVariables.playerContainer[playerId].draw()},render=function(){update(),draw(),requestAnimationFrame(render)};Collisions.collisionDetection=function(a,b){var c=Math.pow(a.position.x-b.position.x,2),d=Math.pow(a.position.y-b.position.y,2),e=Math.sqrt(c+d);return e<=a.radius+b.radius?!0:!1},Collisions.flagDetection=function(a,b){b.dropped||this.collisionDetection(a,b)&&b.capturedByPlayer(a)},Collisions.playerDetection=function(a,b){return a.team===b.team?this.teammateDetection(a,b):this.enemyDetection(a,b)},Collisions.teammateDetection=function(a,b){return this.collisionDetection(a,b)},Collisions.enemyDetection=function(a,b){var c=this.collisionDetection(a,b);return c&&(a.hasFlag=!1,envVariables.flag.drop()),c},Collisions.baseDetection=function(a,b){return!a.score&&a.hasFlag&&a.team===b.team?this.collisionDetection(a,b):void 0},Collisions.windowDetection=function(a,b){return"x"===b?a>windowVariables.minWidth+(envVariables.player.radius-.01)&&a<windowVariables.maxWidth-(envVariables.player.radius-.01)?!0:!1:a>windowVariables.minHeight+(envVariables.player.radius-.01)&&a<windowVariables.maxHeight-(envVariables.player.radius-.01)?!0:!1};var Flag=function(a,b,c){this.position={x:a.x,y:a.y},this.radius=c||2,this.player=null,this.canvasContext=b,this.poleColor="black",this.flagColor="red",this.dropped=!1};Flag.prototype.capturedByPlayer=function(a){envVariables.player.hasFlag=!0,this.player=a,envVariables.moveSpeed=4},Flag.prototype.drop=function(){this.player=null,this.dropped=!0,this.dropTimer(),envVariables.moveSpeed=5},Flag.prototype.dropTimer=function(){setTimeout(function(){this.dropped=!1}.bind(this),500)},Flag.prototype.update=function(){this.player&&(this.position.x=this.player.position.x,this.position.y=this.player.position.y)},Flag.prototype.draw=function(){this.canvasContext.fillStyle=this.poleColor,this.canvasContext.fillRect(this.position.x,this.position.y-20,5,20),this.canvasContext.fillStyle=this.flagColor;var a=new Path2D;a.lineTo(this.position.x+5,this.position.y-20),a.lineTo(this.position.x+15,this.position.y-15),a.lineTo(this.position.x+5,this.position.y-10),this.canvasContext.fill(a)},$(document).ready(function(){$(document).keydown(function(a){37===a.keyCode?-1===keysPressedArr.indexOf("left")&&keysPressedArr.push("left"):38===a.keyCode?-1===keysPressedArr.indexOf("up")&&keysPressedArr.push("up"):39===a.keyCode?-1===keysPressedArr.indexOf("right")&&keysPressedArr.push("right"):40===a.keyCode&&-1===keysPressedArr.indexOf("down")&&keysPressedArr.push("down")}),$(document).keyup(function(a){37===a.keyCode?keysPressedArr.indexOf("left")>=0&&keysPressedArr.splice(keysPressedArr.indexOf("left"),1):38===a.keyCode?keysPressedArr.indexOf("up")>=0&&keysPressedArr.splice(keysPressedArr.indexOf("up"),1):39===a.keyCode?keysPressedArr.indexOf("right")>=0&&keysPressedArr.splice(keysPressedArr.indexOf("right"),1):40===a.keyCode&&keysPressedArr.indexOf("down")>=0&&keysPressedArr.splice(keysPressedArr.indexOf("down"),1)})});var Player=function(a,b,c,d,e,f,g){this.username=a,this.id=b,this.position={x:c.x,y:c.y},this.canvasContext=d,this.team=e,0===this.team?this.color="rgb(0,255,255)":this.color="rgb(255,153,255)",this.radius=g||10,this.hasFlag=f,this.score=!1};Player.prototype.draw=function(){this.canvasContext.beginPath(),this.canvasContext.arc(this.position.x,this.position.y,this.radius,0,2*Math.PI,!1),this.canvasContext.fillStyle=this.color,this.canvasContext.fill(),this.canvasContext.lineWidth=2,0===this.team?this.canvasContext.strokeStyle="rgb(0,0,200)":this.canvasContext.strokeStyle="rgb(255,0,0)",this.canvasContext.stroke()};var userName=function(){for(var a="";""===a;)a=prompt("What's your screenName?");return a};socket.emit("join",userName()),socket.on("getEnvironment",function(a){var b=JSON.parse(a);envVariables.flag=new Flag(b.flag.position,canvasContext,b.flag.radius),envVariables.base0=new Base(b.base0.position,canvasContext,0,b.base0.radius),envVariables.base1=new Base(b.base1.position,canvasContext,1,b.base1.radius),envVariables.score=b.teamScores,uiUpdateScore()}),socket.on("createPlayer",function(a){var b=JSON.parse(a);envVariables.player=new Player(b.name,b.id,b.position,canvasContext,b.team,b.hasFlag.position,b.radius),render(),uiUpdatePlayers()}),socket.on("newPlayer",function(a){var b=JSON.parse(a);envVariables.playerContainer[b.id]=new Team(b.name,b.id,b.position,canvasContext,b.team,b.hasFlag,b.radius),uiUpdatePlayers()}),socket.on("broadcastPlayerPosition",function(a){var b=JSON.parse(a);envVariables.playerContainer[b.id].position=b.position}),socket.on("broadcastFlagPosition",function(a){var b=JSON.parse(a);envVariables.flag.position=b.position}),socket.on("broadcastPlayerDisconnect",function(a){var b=JSON.parse(a),c=b.id;b.hasFlag&&envVariables.flag.drop(),delete envVariables.playerContainer[c],uiUpdatePlayers()}),socket.on("updateScoreFlag",function(a){var b=JSON.parse(a);envVariables.player.score=!1,envVariables.score=b.teamScores,envVariables.flag.position=b.flag.position,uiUpdateScore()}),socket.on("winReset",function(a){var b=JSON.parse(a);envVariables.winningTeam=b.winningTeamId,envVariables.player.team!==envVariables.winningTeam&&(envVariables.moveSpeed=0),envVariables.score=b.teamScores,envVariables.winCondition=!0,setTimeout(function(){envVariables.flag.position=b.flag.position,envVariables.player.score=!1,envVariables.moveSpeed=5,envVariables.winCondition=!1,envVariables.flag.drop(),envVariables.winningTeam=null;for(var a in b.players)envVariables.player.id===a?envVariables.player.position=b.players[a].position:envVariables.playerContainer[a].position=b.players[a].position},7e3),uiUpdateScore()});var Team=function(a,b,c,d,e,f){Player.apply(this,arguments),this.team=e,0===this.team?this.color="rgb(0,0,200)":this.color="rgb(255,0,0)"};Team.prototype=Object.create(Player.prototype),Team.prototype.constructor=Team;var $ui=$(".ui"),uiUpdateScore=function(){var a=$(".team0 h2").text(""),b=$(".team1 h2").text("");a.text("Blue Team's Score: "+envVariables.score[0]),b.text("Red Team's Score: "+envVariables.score[1])},uiUpdatePlayers=function(){var a=($(".playerteam0").html(""),$(".playerteam1").html(""),"playerteam"+envVariables.player.team);$("."+a).append("<li>"+envVariables.player.username+"</li>"),$.each(envVariables.playerContainer,function(a,b){var c="playerteam"+b.team;$("."+c).append("<li>"+b.username+"</li>")})};